<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OQR Dashboard</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/themes/airbnb.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/virtual-select-plugin@1.0.39/dist/virtual-select.min.css">

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='sidebar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='filter.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='card.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='chart.css') }}">
</head>

<body>

    {% from 'macros/charts.html' import render_chart %}

    {% include 'components/sidebar.html' %}

    <main class="main-content">

        {% include 'components/header.html' %}
        {% include 'components/filters.html' %}

        <div class="content-body">
            <div class="dashboard-stats">
                {% include 'components/card_revenue.html' %}
            </div>

            <div class="charts-grid">

                {{ render_chart('hourlyTrendChart', 'Biểu đồ Doanh thu & Đơn hàng theo giờ', '400px', 'span-2') }}

                {{ render_chart('statusPieChart', 'Trạng Thái Đơn Hàng', '400px') }}

                {{ render_chart('vietnamMap', 'Mật độ đơn hàng theo Tỉnh/Thành', '400px') }}
            </div>

            <div class="charts-grid">
                {{ render_chart('brandPlatformChart', 'Doanh Số Theo Brand Và Nền Tảng', '500px', 'span-2') }}
                {{ render_chart('brandPerformancePie', 'Doanh Số Theo Brand', '500px') }}
            </div>
        </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/virtual-select-plugin@1.0.39/dist/virtual-select.min.js"></script>

    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/maps/modules/map.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/mapdata/countries/vn/vn-all.js"></script>

    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
    <script src="{{ url_for('static', filename='js/datepicker.js') }}"></script>
    <script src="{{ url_for('static', filename='js/filters.js') }}"></script>

    <script src="{{ url_for('static', filename='js/chart_map.js') }}"></script>

    <script src="{{ url_for('static', filename='js/chart_factory.js') }}"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // 1. Lấy dữ liệu từ Python (Sửa tên biến cho khớp với Python của bạn)

            // Dữ liệu Line Chart (Ghép từ 3 biến rời thành 1 object)
            const hourlyData = {
                hours: {{ chart_labels | tojson | default ('[]')
        }},
            revenue: {{ chart_revenue | tojson | default('[]') }},
            orders: {{ chart_orders | tojson | default('[]') }}
            };

        // Dữ liệu Pie Chart (Lấy raw_status và map lại cho đúng format Highcharts)
        const rawStatus = {{ raw_status | tojson | default ('[]') }};
        const pieData = rawStatus.map(item => ({
            name: item.StatusName || 'Unknown',
            y: item.Orders
        }));

        // Dữ liệu Map
        const mapData = {{ raw_province | tojson | default ('[]') }};

        // Dữ liệu Bar Chart
        const barData = {{ raw_brand_platform | tojson | default ('null') }};

        // 2. Vẽ biểu đồ bằng Factory

        // Vẽ Line Chart
        if (hourlyData.hours && hourlyData.hours.length > 0) {
            ChartFactory.createDualLine('hourlyTrendChart', hourlyData);
        }

        // Vẽ Pie Chart
        if (pieData && pieData.length > 0) {
            ChartFactory.createDonut('statusPieChart', pieData);
        }

        // Vẽ Map (Nếu hàm initVietnamMap đã được load từ chart_map.js)
        if (mapData && typeof initVietnamMap === 'function') {
            initVietnamMap(mapData);
        }

        // Vẽ Bar Chart (Stacked)
        if (barData) {
            ChartFactory.createStackedBar('brandPlatformChart', barData);
        }
        const brandPieData = {{ brand_pie_data | tojson | default ('[]') }};
        // Lấy chuỗi tổng doanh thu đã format sẵn từ Python (để hiện giữa biểu đồ)
        // Lưu ý: Biến brand_total được truyền từ route b2c.py
        const totalRevenueStr = '{{ "{:,.0f}".format(brand_total.revenue) if brand_total else "0" }}';

        // 2. Vẽ biểu đồ bằng Factory mới
        if (brandPieData && brandPieData.length > 0) {
            ChartFactory.createBrandDonut('brandPerformancePie', brandPieData, totalRevenueStr);
        }
        });
    </script>

</body>

</html>