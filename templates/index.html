<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OQR Dashboard</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/themes/airbnb.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/virtual-select-plugin@1.0.39/dist/virtual-select.min.css">

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='sidebar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='filter.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='card.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='chart.css') }}">
</head>

<body>

    {% raw %}{% endraw %}{% from 'macros/charts.html' import render_chart %}
    {% from 'macros/chart_components.html' import render_perf_card %}

    {% include 'components/sidebar.html' %}

    <main class="main-content">

        {% include 'components/header.html' %}
        {% include 'components/filters.html' %}

        <div class="content-body">
            <div class="dashboard-stats">
                {% include 'components/card_revenue.html' %}
            </div>

            <div class="charts-grid">
                {{ render_chart('hourlyTrendChart', 'Biểu đồ Doanh thu & Đơn hàng theo giờ', '400px', 'span-3') }}
                {{ render_chart('statusPieChart', 'Trạng Thái Đơn Hàng', '400px') }}
                {{ render_chart('vietnamMap', 'Mật độ đơn hàng theo Tỉnh/Thành', '400px') }}
            </div>

            <div class="charts-grid">
                {{ render_chart('brandPlatformChart', 'Doanh Số Theo Brand Và Nền Tảng', '400px', 'span-2') }}
                {{ render_perf_card(
                chart_id='brandPerformancePie',
                title='Doanh Số Theo Brand',
                data_rows=brand_table,
                data_total=brand_total,
                max_vals=max_vals,
                entity_label='Brand',
                entity_key='brand'
                ) }}
            </div>
        </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/virtual-select-plugin@1.0.39/dist/virtual-select.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://code.highcharts.com/maps/modules/map.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/mapdata/countries/vn/vn-all.js"></script>

    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/datepicker.js') }}"></script>
    <script src="{{ url_for('static', filename='js/filters.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chart_builder.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chart_map.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chart_factory.js') }}"></script>

    <!-- Inject Data for Dashboard Script -->
    <script>
        // Sử dụng biến toàn cục để truyền dữ liệu từ Python sang JS một cách an toàn
        window.dashboardData = {
            // Dữ liệu Line Chart
            chartLabels: {{ chart_labels | tojson | safe }},
            chartRevenue: {{ chart_revenue | tojson | safe }},
            chartOrders: {{ chart_orders | tojson | safe }},

            // Dữ liệu Pie Chart (Status)
            rawStatus: {{ raw_status | tojson | safe }},

            // Dữ liệu Map
            rawProvince: {{ raw_province | tojson | safe }},

            // Dữ liệu Bar Chart (Stacked)
            rawBrandPlatform: {{ raw_brand_platform | tojson | safe }},

            // Dữ liệu Donut Chart (Brand Performance)
            brandPieData: {{ brand_pie_data | tojson | safe }},

        // Tổng doanh thu (String đã format sẵn từ Python, nhớ dùng dấu nháy đơn bao quanh)
        brandTotalRevenue: '{{ "{:,.0f}".format(brand_total.revenue) if brand_total else "0" }}'
        };
    </script>

    <!-- Page Specific Script -->
    <script src="{{ url_for('static', filename='js/pages/dashboard.js') }}"></script>

</body>

</html>